{% extends "base.html" %}
{% load static %}
{% block content %}

{% if user.is_authenticated %}
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <button id="searchBtn" class="btn">ê²€ìƒ‰</button>
    </div>

    <div class="todocontainer"></div>
    <div class="pagination"></div>
    <button class="todoCreate" id="createBtn">Todo ë“±ë¡í•˜ê¸°</button>
{% else %}
    <p>í•  ì¼ ëª©ë¡ì€ ë¡œê·¸ì¸ í›„ì— í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
{% endif %}

<script>
let currentPage = 1; //í˜„ì¬ í˜ì´ì§€ë¥¼ ê¸°ì–µí•˜ëŠ” ì „ì—­ë³€ìˆ˜
let currentSearch = "";

// 1. ë¬¸ì„œê°€ ì™„ì „íˆ ë¡œë“œë˜ë©´ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
document.addEventListener("DOMContentLoaded", init);

// 2. ì´ˆê¸°í™”: UI ì´ë²¤íŠ¸ ì—°ê²° ë° ì²« í˜ì´ì§€ Todo ëª©ë¡ ë¡œë“œ
function init(){
    UIEvents();
    loadTodoList(1); //ëª©ë¡ë¶ˆëŸ¬ì˜¤ê¸°(data,page)
}

// 2-1. UI ì´ë²¤íŠ¸ ë°”ì¸ë”©: "Todo ë“±ë¡í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™
function UIEvents(){
    document.getElementById("createBtn").addEventListener("click", onCreateClick);
    // ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.getElementById("searchBtn").addEventListener("click", () => {
        currentSearch = document.getElementById("searchInput").value.trim();
        loadTodoList(1);
    })
}

// 2-1-1. ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ /todo/create/ë¡œ ì´ë™
function onCreateClick(){
    window.location.href = "/todo/create/";
}

// 3. ì„œë²„ì—ì„œ Todo ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
function loadTodoList(page){
    currentPage = page; // í˜„ì¬ í˜ì´ì§€ ë³€ìˆ˜ ìƒì„±
    fetchTodoData(currentPage, currentSearch)
    .then(data => {
        const todos = extractTodoArray(data); //
        renderTodoList(todos); //íƒ¬í”Œë¦¿ì„ ê¾¸ë©°ì„œ í™”ë©´ì— ì¶œë ¥í•˜ê¸° í•¨ìˆ˜
        renderPagination(data, page);
    })
    .catch(err => console.error('ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨', err));
}

// 3-1. axiosë¥¼ ì´ìš©í•´ ì„œë²„ë¡œë¶€í„° íŠ¹ì • í˜ì´ì§€ì˜ Todo ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
function fetchTodoData(page, search=""){
    return axiosInstance
    // .get(`/todo/viewsets/view/?page=${currentPage}`) // í˜ì´ì§€ë„¤ì´ì…˜ ë°ì´í„° ìš”ì²­
    .get(`/todo/viewsets/view/`, {
        params: {page, search}
    })
    .then(res => {
        console.log("ì‘ë‹µë°ì´í„°:", res.data);
        return res.data;
    }); 
}

// 3-2. API ì‘ë‹µ í˜•ì‹ì— ë”°ë¼ Todo ë°°ì—´ ì¶”ì¶œ(í˜ì´ì§€ë„¤ì´ì…˜ë“¤ì–´ì˜¤ë©´ if ì¶”ê°€)
function extractTodoArray(data){
    if(Array.isArray(data)) return data; //ë°ì´í„° ê²€ìˆ˜
    if(Array.isArray(data.data)) return data.data;
    return [];
}

// 3-3. ì¶”ì¶œëœ Todo í•­ëª©ë“¤ì„ í™”ë©´ì— ë Œë”ë§
function renderTodoList(todos){
    const container = document.querySelector(".todocontainer"); // .todocontainer{}
    container.innerHTML = "";
    todos.forEach(todo => 
        container.appendChild(createTodoElement(todo))
    );
}

// 3-3-1. ë‹¨ì¼ Todo ê°ì²´ë¥¼ HTML ìš”ì†Œë¡œ ìƒì„±
function createTodoElement(todo){
    const div = document.createElement("div");
    div.className = "todo-item"; //<div class="todo-item completed"></div>

    // ì™„ë£Œëœ í•­ëª©ì´ë©´ ë°‘ì¤„ ì ìš©
    if (todo.complete){
        div.classList.add("completed"); 
    }

    // ëª©ë¡ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ ì´ë™
    div.addEventListener("click", () => detailView(todo.id))

    // HTML ë‚´ìš© ì„¤ì •
    div.innerHTML = `
        <p><strong>Name:</strong> ${todo.name}</p>
        <p><strong>Description:</strong> ${todo.description}</p>
        <p><strong>Complete:</strong> ${todo.complete}</p>
        <p><strong>Completed At:</strong> ${datetimeToString(todo.completed_at)}</p>
        <p><strong>Experience Points:</strong> ${todo.exp}</p>
        <p><strong>Image:</strong><br> ${todo.image ? `<img src="${todo.image}" alt="${todo.image}" width="150">` : ""}</p>
        <button class="social-btn likeBtn" data-id="${todo.id}"><span class="icon">${todo.is_liked ? 'ğŸ’”' : 'â¤ï¸'}</span> <span class="count">${todo.like_count}</span></button>
        <button class="social-btn bookmarkBtn" data-id="${todo.id}"><span class="icon">ğŸ”– </span><span class="count">${todo.bookmark_count}</span></button>
        <button class="social-btn commentToggleBtn"><span class="icon">ğŸ’¬ </span><span class="count">${todo.comment_count || 0}</span></button>
        <div class="commentBox" style="display:none;">
            <ul class="commentList"></ul>
            <input type="text" class="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button class="commentSubmit">ë“±ë¡</button>
        </div>
        <button class="social"><a href="/interaction/todo/detail/${todo.id}/" target="_blank" class="detail-link">MYëŒ“ê¸€</a></button>
        <button class="completeBtn">ì™„ë£Œ</button>
    `;

    div.querySelector(".completeBtn")
        .addEventListener('click', e => {
            e.stopPropagation();
            toComplete(todo.id);
            console.log("ì™„ë£Œë²„íŠ¼ í´ë¦­");
    });

    // ì¢‹ì•„ìš” ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡    
    div.querySelectorAll('.likeBtn').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.stopPropagation();
            toggleLike(btn.dataset.id); // "data-id" ì†ì„±ì— ë‹´ê¸´ ê°’ì„ ì¸ìë¡œ ì „ë‹¬í•´ì„œ toggleLike() í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë¼.
        });
    });

    // ë¶ë§ˆí¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡    
    div.querySelectorAll('.bookmarkBtn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleBookmark(btn.dataset.id); 
        });
    });

    // ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼
    div.querySelectorAll('.commentSubmit').forEach(btn => {
        btn.addEventListener('click', e => {
            e.stopPropagation();
            const commentInput = div.querySelector('.commentInput');
            const content = commentInput.value;
            if (content.trim()) {
                postComment(todo.id, content);
                commentInput.value = '';
            }
        });
    });

    // ëŒ“ê¸€ í† ê¸€ ë²„íŠ¼
    div.querySelectorAll('.commentToggleBtn').forEach(btn => {
        btn.addEventListener('click', e => {
            e.stopPropagation();
            const commentBox = div.querySelector('.commentBox');
            commentBox.style.display = (commentBox.style.display === 'none') ? 'block' : 'none';
            loadComments(todo.id, div.querySelector('.commentList'));
        });
    });

    // ëŒ“ê¸€ ì…ë ¥ì°½ í´ë¦­ ì‹œ, ìƒìœ„ div í´ë¦­ ì´ë²¤íŠ¸(ìƒì„¸í˜ì´ì§€ ì´ë™)ë¥¼ ë§‰ëŠ”ë‹¤
    div.querySelector('.commentInput')
        .addEventListener('click', e => e.stopPropagation());

    //íŒì—…ì°½ ì—´ê¸°
    div.querySelector('.detail-link')?.addEventListener('click', e => {
    e.stopPropagation(); // ìƒìœ„ div í´ë¦­ ì´ë²¤íŠ¸ ë§‰ê¸°

        // ìƒˆì°½ ì—´ê¸° (í¬ê¸°ì™€ ìœ„ì¹˜ ì§€ì •)
        window.open(
            `/interaction/todo/detail/${todo.id}/`, // ì—´ URL
            '_blank', // ìƒˆì°½
            'width=600,height=600,top=100,left=200,scrollbars=yes,resizable=yes' // ì˜µì…˜
            ); 
    });  

    return div;   
}

// 3-3-2. ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ Todo í•­ëª©ì„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
function toComplete(id){
    axiosInstance.patch(`/todo/viewsets/view/${id}/`, {complete:true}) //
    .then(() => loadTodoList(currentPage)) // í˜„ì¬í˜ì´ì§€ë¡œ ìƒˆë¡œê³ ì¹¨
    .catch(err => console.error("ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:", err)); 
}

// 3-3-3. ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ (â† ì´ì „, 1 2 3, â†’ ë‹¤ìŒ)
function detailView(id) {
    window.location.href = `/todo/detail/${id}/`;
}

// 3-4. í˜ì´ì§€ë„¤ì´ì…˜ êµ¬ì„±
function renderPagination(data, currentPage) {
    const wrapper = document.querySelector('.pagination');
    wrapper.innerHTML = '';

    const totalPages = data.page_count;

     // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
    const prevBtn = document.createElement('button');
    prevBtn.innerText = '<';
    prevBtn.disabled = !data.previous; 
    //data.previousëŠ” Django REST Framework(DRF)ì—ì„œ ê¸°ë³¸ ì œê³µí•˜ëŠ” í˜ì´ì§€ë„¤ì´ì…˜ ì‘ë‹µ ì†ì„± ì´ë¦„ì…ë‹ˆë‹¤.
    prevBtn.addEventListener('click', () => loadTodoList(currentPage - 1));
    wrapper.appendChild(prevBtn);

    // ê°œë³„ í˜ì´ì§€ ë²„íŠ¼ë“¤ ìƒì„±
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        if (i === currentPage) { //ì—„ê²©í•œë¹„êµ
            btn.disabled = true;
            btn.classList.add('active');  // CSSë¡œ .active ìŠ¤íƒ€ì¼ ì§€ì •
        }
        btn.addEventListener('click', () => loadTodoList(i)); // âœ…ì˜¤íƒ€
        wrapper.appendChild(btn);
    }

    // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
    const nextBtn = document.createElement('button');
    nextBtn.innerText = '>';
    nextBtn.disabled = !data.next;
    nextBtn.addEventListener('click', () => loadTodoList(currentPage + 1)); // âœ…ì˜¤íƒ€
    wrapper.appendChild(nextBtn);
}

// ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜
function toggleLike(id) {
    axiosInstance
        .post(`/interaction/likes/${id}/toggle/`)
        .then(res => {
            const { is_liked, like_count } = res.data;
            const btn = document.querySelector(`.likeBtn[data-id="${id}"]`);
            if (btn) btn.innerHTML = `${is_liked ? 'ğŸ’”' : 'â¤ï¸'} <span class="count">${like_count}</span>`;
        })
        .catch(err => console.error(" ì¢‹ì•„ìš” í† ê¸€ ì‹¤íŒ¨:", err));
}

// ë¶ë§ˆí¬ í† ê¸€ í•¨ìˆ˜
function toggleBookmark(id) {
    axiosInstance
        .post(`/interaction/bookmarks/${id}/toggle/`)
        .then(res => {
            const { is_bookmarked, bookmark_count } = res.data;
            const btn = document.querySelector(`.bookmarkBtn[data-id="${id}"]`);
            if (btn) btn.innerHTML = `ğŸ”– <span class="count">${bookmark_count}</span>`;
        })
        .catch(err => console.error(' ë¶ë§ˆí¬ í† ê¸€ ì‹¤íŒ¨:', err));
}

// ëŒ“ê¸€ ë“±ë¡ í•¨ìˆ˜
function postComment(todoId, content) {
  if (!content) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");
  axiosInstance.post("interaction/comments/", { todo_pk: todoId, content: content })
    .then(() => {
      loadComments(todoId, document.querySelector('.commentList'));
    })
    .catch(error => {
      console.error(" ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:", error.response?.data || error);
      alert(" ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:\n" + JSON.stringify(error.response?.data, null, 2));
    });
}

// ëŒ“ê¸€ ëª©ë¡ ë¡œë”© í•¨ìˆ˜
function loadComments(todoId, listElement) {
  axiosInstance.get(`/interaction/comments/`, { params: { todo_pk: todoId } })
    .then(res => {
      const payload = Array.isArray(res.data) ? res.data : Array.isArray(res.data.results) ? res.data.results : (res.data.data || []);
      /*
      ìœ„ ì½”ë“œëŠ” ì¡°ê±´ë¬¸ì´ ë‘ ê°œ ì—°ê²°ë˜ì–´ ìˆëŠ” í˜•íƒœ
      if (Array.isArray(res.data)) {
          payload = res.data;
      } else if (Array.isArray(res.data.results)) {
          payload = res.data.results;
      } else {
          payload = res.data.data || [];
      }
      */
      listElement.innerHTML = '';
      payload.forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `${c.user.username || c.username}: ${c.content} 
          <button class="comment-like-btn" data-id="${c.id}">ğŸ‘ ${c.like_count}</button>`;
        li.querySelector('.comment-like-btn')?.addEventListener('click', e => {
          e.stopPropagation();
          toggleCommentLike(c.id);
        });
        listElement.appendChild(li);
      });
    })
    .catch(err => console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', err));
}

// ëŒ“ê¸€ ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜
function toggleCommentLike(commentId) {
  axiosInstance.post(`/interaction/commentlikes/${commentId}/toggle/`)
    .then(res => {
      const btn = document.querySelector(`.comment-like-btn[data-id="${commentId}"]`);
      if (btn) btn.innerHTML = `ğŸ‘ ${res.data.like_count}`;
    })
    .catch(err => console.error("ëŒ“ê¸€ ì¢‹ì•„ìš” ì‹¤íŒ¨:", err));
}

</script>  
{% endblock %}